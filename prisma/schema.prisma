generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Project {
  id            String      @id @default(uuid())
  projectNumber String      @unique
  name          String
  status        String      @default("ACTIVE") // ACTIVE, ARCHIVED
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  createdBy     String?
  modifiedBy    String?

  usages        Usage[]
  usageLines    UsageLine[]
  remnants      Remnant[] // Scrap or Remnants produced by this project
}


model GlobalSettings {
  id              String @id @default("settings") // Singleton
  updatedAt       DateTime @updatedAt
}

// SteelProfile represents a unique Shape (Type + Dimensions)
model SteelProfile {
  id         String   @id @default(uuid())
  type       String   // e.g., HEA, IPE
  dimensions String   // e.g., 200, 300, 10x100
  weightPerMeter Float @default(0) // kg/m
  
  inventory  Inventory[]
  remnants   Remnant[]

  @@unique([type, dimensions])
}

model StandardProfile {
  id              String   @id @default(uuid())
  type            String   // e.g., HEA, IPE
  dimensions      String   // e.g., 200, 300
  weightPerMeter  Float    // kg/m
  crossSectionArea Float?  // mm^2, optional for legacy or simple profiles
  
  @@unique([type, dimensions])
}

// ProfileShape defines custom shapes (e.g. "RHS") and their input parameters
model ProfileShape {
  id      String   @id // e.g., "RHS"
  name    String   // e.g., "Rectangular Hollow Section"
  params  Json     // e.g., ["h", "w", "t"]
  formula String?  // Documentation only for now
}

model MaterialGrade {
  id         String @id @default(uuid())
  name       String @unique // e.g., S355
  density    Float  @default(7.85) // kg/dm3
  scrapPrice Float  @default(0)    // â‚¬/kg
  
  inventory Inventory[]
  remnants  Remnant[]
}

model Supplier {
  id        String   @id @default(uuid())
  name      String   @unique
  code      String?  // Short code for reference
  contact   String?  // Contact person name
  email     String?
  phone     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inventory Inventory[]
}

model Inventory {
  id                String   @id @default(uuid())
  lotId             String   @unique
  profileId         String
  gradeId           String
  supplierId        String?  // Optional supplier reference
  length            Float    // mm
  quantityReceived  Int
  quantityAtHand    Int
  costPerMeter      Float    @default(0)
  certificateFilename String?
  status            String   @default("ACTIVE") // ACTIVE, EXHAUSTED
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?
  modifiedBy        String?

  profile           SteelProfile @relation(fields: [profileId], references: [id])
  grade             MaterialGrade @relation(fields: [gradeId], references: [id])
  supplier          Supplier?    @relation(fields: [supplierId], references: [id])
  usageLines        UsageLine[]

  @@index([status])
  @@index([profileId])
  @@index([gradeId])
  @@index([supplierId])
}

model Remnant {
  id          String   @id // Manual/Generated: {RootLotId}-{Length}
  rootLotId   String   // Link to original parent lot
  profileId   String
  gradeId     String
  length      Float    // mm
  quantity    Int      @default(1)
  costPerMeter Float     @default(0)
  status      String   @default("AVAILABLE") // AVAILABLE, USED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy         String?
  modifiedBy        String?
  projectId         String? // Origin Project (useful for Scrap tracking)

  profile     SteelProfile @relation(fields: [profileId], references: [id])
  grade       MaterialGrade @relation(fields: [gradeId], references: [id])
  project     Project?     @relation(fields: [projectId], references: [id])
  usageLines  UsageLine[]

  @@index([status])
  @@index([rootLotId])
  @@index([projectId])
}

model Usage {
  id        String   @id @default(uuid())
  projectId String
  date      DateTime @default(now())
  userId    String   // NextAuth user ID
  createdBy String?
  modifiedBy String?
  
  project   Project  @relation(fields: [projectId], references: [id])
  lines     UsageLine[]

  @@index([projectId])
  @@index([date])
}

model UsageLine {
  id           String  @id @default(uuid())
  usageId      String
  inventoryId  String?
  remnantId    String?
  quantityUsed Int     // Mostly 1 for remnants, but could be more for inventory
  cost         Float   @default(0)
  projectId    String? // Optional override

  usage        Usage      @relation(fields: [usageId], references: [id], onDelete: Cascade)
  inventory    Inventory? @relation(fields: [inventoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  remnant      Remnant?   @relation(fields: [remnantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  project      Project?   @relation(fields: [projectId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([usageId])
  @@index([inventoryId])
  @@index([remnantId])
}
