generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// ============================================================================
// ENUMS
// ============================================================================

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ON_HOLD
  ARCHIVED
}

enum ProjectPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
  URGENT
}

enum WorkOrderPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum InventoryStatus {
  ACTIVE
  EXHAUSTED
}

enum RemnantStatus {
  AVAILABLE
  USED
  SCRAP
}

enum PartPieceStatus {
  PENDING
  CUT
  FABRICATED
  WELDED
  PAINTED
  READY
}

enum AssemblyStatus {
  PENDING
  NOT_STARTED
  IN_PROGRESS
  ASSEMBLED
  QC_PASSED
  SHIPPED
}

enum WorkOrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum WorkOrderType {
  MATERIAL_PREP
  CUTTING
  MACHINING
  FABRICATION
  WELDING
  PAINTING
  ASSEMBLY
  COATING
}

enum QualityCheckStatus {
  PENDING
  PASSED
  FAILED
  WAIVED
}

enum ProcessStage {
  FABRICATION
  WELDING
  PAINTING
  FINAL
}

enum QualityCheckType {
  VISUAL
  DIMENSIONAL
  NDT
  COATING
}

enum DeliveryStatus {
  PENDING
  SHIPPED
  DELIVERED
}

enum PlatePartStatus {
  PENDING
  ORDERED
  IN_PRODUCTION
  RECEIVED
  QC_PASSED
}

enum PlatePieceStatus {
  PENDING
  CUT
  RECEIVED
  QC_PASSED
}

enum OptimizationJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Customer {
  id            String   @id @default(uuid())
  companyName   String
  contactName   String?
  contactEmail  String?
  contactPhone  String?
  address       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  projects      Project[]
}

model Project {
  id              String      @id @default(uuid())
  projectNumber   String      @unique
  name            String
  client          String?              // Legacy field, migrate to customerId
  customerId      String?
  customer        Customer?   @relation(fields: [customerId], references: [id])
  description     String?
  priority        ProjectPriority @default(MEDIUM)
  scheduledStart  DateTime?
  scheduledEnd    DateTime?
  status          ProjectStatus   @default(ACTIVE)
  coatingType     String?              // HDG, PAINTED, POWDER_COATED, etc.
  coatingSpec     String?              // Coating specification details (e.g., "RAL 7016")
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  createdBy       String?
  modifiedBy      String?

  corrosionCategory String?            // e.g. C3, C4, C5
  corrosionDurability String?          // e.g. L, M, H, VH (Low, Medium, High, Very High)
  corrosionComments String?
  contractDate      DateTime?
  estimatedHours    Float?
  deliveryDate      DateTime?

  usages            Usage[]
  usageLines        UsageLine[]
  remnants          Remnant[]           // Scrap or Remnants produced by this project
  parts             Part[]
  assemblies        Assembly[]
  deliverySchedules DeliverySchedule[]
  qualityChecks     QualityCheck[]
  workOrders        WorkOrder[]
  documents         ProjectDocument[]
  plateParts        PlatePart[]
  optimizationJobs  OptimizationJob[]
}


model GlobalSettings {
  id              String @id @default("settings") // Singleton
  updatedAt       DateTime @updatedAt
  
  // Numbering Schemas
  ncrFormat       String @default("NCR-{YYYY}-{SEQ}")
  ncrNextSeq      Int    @default(1)
  
  lotFormat       String @default("LOT-{YY}{MM}-{SEQ}")
  lotNextSeq      Int    @default(1)
  
  projectFormat   String @default("P-{YY}-{SEQ}")
  projectNextSeq  Int    @default(1)
  
  scrapPricePerKg Float  @default(0.15)
}

// SteelProfile represents a unique Shape (Type + Dimensions)
model SteelProfile {
  id         String   @id @default(uuid())
  type       String   // e.g., HEA, IPE
  dimensions String   // e.g., 200, 300, 10x100
  weightPerMeter Float @default(0) // kg/m
  
  inventory  Inventory[]
  remnants   Remnant[]
  parts      Part[]

  @@unique([type, dimensions])
}

model StandardProfile {
  id              String   @id @default(uuid())
  type            String   // e.g., HEA, IPE
  dimensions      String   // e.g., 200, 300
  weightPerMeter  Float    // kg/m
  crossSectionArea Float?  // mm^2, optional for legacy or simple profiles
  
  @@unique([type, dimensions])
}

// ProfileShape defines custom shapes (e.g. "RHS") and their input parameters
model ProfileShape {
  id      String   @id // e.g., "RHS"
  name    String   // e.g., "Rectangular Hollow Section"
  params  Json     // e.g., ["h", "w", "t"]
  formula String?  // Documentation only for now
}

model MaterialGrade {
  id         String @id @default(uuid())
  name       String @unique // e.g., S355
  density    Float  @default(7.85) // kg/dm3
  scrapPrice Float  @default(0)    // €/kg
  
  inventory  Inventory[]
  remnants   Remnant[]
  parts      Part[]
  plateParts PlatePart[]
}

model Supplier {
  id        String   @id @default(uuid())
  name      String   @unique
  code      String?  // Short code for reference
  contact   String?  // Contact person name
  email     String?
  phone     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inventory Inventory[]
}

model Inventory {
  id                String   @id @default(uuid())
  lotId             String   @unique
  profileId         String
  gradeId           String
  supplierId        String?  // Optional supplier reference
  invoiceNumber     String?  // Purchase invoice reference
  length            Float    // mm
  quantityReceived  Int
  quantityAtHand    Int
  costPerMeter      Float    @default(0)
  certificateFilename String?
  status            InventoryStatus @default(ACTIVE)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?
  modifiedBy        String?

  profile           SteelProfile @relation(fields: [profileId], references: [id])
  grade             MaterialGrade @relation(fields: [gradeId], references: [id])
  supplier          Supplier?    @relation(fields: [supplierId], references: [id])
  usageLines        UsageLine[]
  partPieces        PartPiece[]
  platePieces       PlatePiece[]

  @@index([status])
  @@index([profileId])
  @@index([gradeId])
  @@index([supplierId])
}

model Remnant {
  id          String   @id // Manual/Generated: {RootLotId}-{Length}
  rootLotId   String   // Link to original parent lot
  profileId   String
  gradeId     String
  length      Float    // mm
  quantity    Int      @default(1)
  costPerMeter Float     @default(0)
  status      RemnantStatus @default(AVAILABLE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy         String?
  modifiedBy        String?
  projectId         String? // Origin Project (useful for Scrap tracking)

  profile     SteelProfile @relation(fields: [profileId], references: [id])
  grade       MaterialGrade @relation(fields: [gradeId], references: [id])
  project     Project?     @relation(fields: [projectId], references: [id])
  usageLines  UsageLine[]
  partPieces  PartPiece[]

  @@index([status])
  @@index([rootLotId])
  @@index([projectId])
}

model Usage {
  id        String   @id @default(uuid())
  projectId String
  date      DateTime @default(now())
  userId    String   // NextAuth user ID
  userName  String?  // Human readable name (snapshot)
  createdBy String?
  modifiedBy String?
  
  project   Project  @relation(fields: [projectId], references: [id])
  lines     UsageLine[]

  @@index([projectId])
  @@index([date])
}

model UsageLine {
  id           String  @id @default(uuid())
  usageId      String
  inventoryId  String?
  remnantId    String?
  quantityUsed Int     // Mostly 1 for remnants, but could be more for inventory
  cost         Float   @default(0)
  projectId    String? // Optional override

  // Enhanced Fields
  workOrderItemId  String?
  usageType        String  @default("STANDALONE") // PROJECT_WO, PROJECT_CONDUCTOR, INTERNAL, STANDALONE
  valRemnantLength Float?  // Adjusted offcut length (if different from calc)
  isScrap          Boolean @default(false)
  overrideReason   String?

  usage            Usage          @relation(fields: [usageId], references: [id], onDelete: Cascade)
  inventory        Inventory?     @relation(fields: [inventoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  remnant          Remnant?       @relation(fields: [remnantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  project          Project?       @relation(fields: [projectId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  workOrderItem    WorkOrderItem? @relation(fields: [workOrderItemId], references: [id])

  @@index([usageId])
  @@index([inventoryId])
  @@index([remnantId])
  @@index([workOrderItemId])
}

// ============================================================================
// PROJECT MANAGEMENT MODULE
// ============================================================================

// Part: Master part definition (project-scoped)
model Part {
  id              String   @id @default(uuid())
  projectId       String
  partNumber      String              // e.g., "P-001", "B-101"
  description     String?
  profileId       String?             // Link to SteelProfile (if exists)
  gradeId         String?             // Link to MaterialGrade
  // Custom profile fields (when profileId is null or custom dimensions)
  profileType     String?             // e.g., "RHS", "CHS", "SHS", "HEA", etc.
  profileDimensions String?           // e.g., "100x50x4", "139.7x6.3"
  profileStandard String?             // e.g., "EN 10219", "EN 10210"
  length          Float?              // mm
  quantity        Int                 // Total pieces needed
  unitWeight      Float    @default(0)  // kg per piece (calculated)
  requiresWelding Boolean  @default(false)
  isOutsourcedCut Boolean  @default(false) // Laser/plasma cut by external vendor
  cutVendor       String?             // Vendor name for outsourced cutting
  drawingRef      String?             // Drawing number/link
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  project         Project        @relation(fields: [projectId], references: [id])
  profile         SteelProfile?  @relation(fields: [profileId], references: [id])
  grade           MaterialGrade? @relation(fields: [gradeId], references: [id])
  pieces          PartPiece[]
  assemblyParts   AssemblyPart[]

  @@unique([projectId, partNumber])
  @@index([projectId])
  @@index([profileId])
  @@index([gradeId])
}

// PartPiece: Individual piece tracking (piece 1 of 6, piece 2 of 6, etc.)
model PartPiece {
  id              String    @id @default(uuid())
  partId          String
  pieceNumber     Int                 // 1, 2, 3... up to Part.quantity
  status          PartPieceStatus @default(PENDING)
  inventoryId     String?             // Material source (inventory lot)
  remnantId       String?             // Or material from remnant
  cutAt           DateTime?
  fabricatedAt    DateTime?
  weldedAt        DateTime?
  paintedAt       DateTime?
  completedAt     DateTime?
  completedBy     String?
  notes           String?

  // Relations
  part            Part              @relation(fields: [partId], references: [id], onDelete: Cascade)
  inventory       Inventory?        @relation(fields: [inventoryId], references: [id])
  remnant         Remnant?          @relation(fields: [remnantId], references: [id])
  assemblyPieceId String?
  assemblyPiece   AssemblyPiece?    @relation(fields: [assemblyPieceId], references: [id])
  documents       ProjectDocument[]
  workOrderItems  WorkOrderItem[]

  @@unique([partId, pieceNumber])
  @@index([partId])
  @@index([status])
  @@index([inventoryId])
  @@index([remnantId])
  @@index([assemblyPieceId])
}

// Assembly: Grouping of parts (supports nesting via parentId)
model Assembly {
  id              String    @id @default(uuid())
  projectId       String
  parentId        String?             // If sub-assembly, points to parent
  assemblyNumber  String              // e.g., "A-001"
  name            String              // e.g., "Main Frame Section 1"
  description     String?
  quantity        Int       @default(1)  // Total instances (e.g., 5 Frames required)
  sequence        Int       @default(0)  // Fabrication order
  status          AssemblyStatus @default(NOT_STARTED)
  scheduledDate   DateTime?           // When customer needs it
  shippedAt       DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  project           Project              @relation(fields: [projectId], references: [id])
  parent            Assembly?            @relation("SubAssemblies", fields: [parentId], references: [id])
  children          Assembly[]           @relation("SubAssemblies")
  pieces            AssemblyPiece[]
  assemblyParts     AssemblyPart[]
  deliveryItems     DeliveryItem[]
  qualityChecks     QualityCheck[]
  documents         ProjectDocument[]
  workOrderItems    WorkOrderItem[]
  plateAssemblyParts PlateAssemblyPart[]

  @@unique([projectId, assemblyNumber])
  @@index([projectId])
  @@index([parentId])
  @@index([status])
}

// AssemblyPiece: Individual instance tracking (Frame 1 of 5, Frame 2 of 5)
model AssemblyPiece {
  id              String    @id @default(uuid())
  assemblyId      String
  pieceNumber     Int       // 1, 2, ... up to Assembly.quantity
  status          AssemblyStatus @default(PENDING)

  // Timestamps
  assembledAt     DateTime?
  qcPassedAt      DateTime?
  shippedAt       DateTime?
  notes           String?

  // Relations
  assembly        Assembly    @relation(fields: [assemblyId], references: [id], onDelete: Cascade)
  childPieces     PartPiece[] // The parts that make up this specific assembly instance

  @@unique([assemblyId, pieceNumber])
  @@index([assemblyId])
  @@index([status])
}

// AssemblyPart: Junction table (which parts belong to which assembly)
model AssemblyPart {
  id                  String   @id @default(uuid())
  assemblyId          String
  partId              String
  quantityInAssembly  Int      @default(1)  // How many of this part in this assembly
  notes               String?

  // Relations
  assembly            Assembly @relation(fields: [assemblyId], references: [id], onDelete: Cascade)
  part                Part     @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@unique([assemblyId, partId])
  @@index([assemblyId])
  @@index([partId])
}

// DeliverySchedule: Customer shipping requirements
model DeliverySchedule {
  id            String   @id @default(uuid())
  projectId     String
  name          String              // e.g., "Phase 1 Delivery", "Week 3 Shipment"
  scheduledDate DateTime
  notes         String?
  status        DeliveryStatus @default(PENDING)
  shippedAt     DateTime?
  deliveredAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  project       Project        @relation(fields: [projectId], references: [id])
  items         DeliveryItem[]

  @@index([projectId])
  @@index([scheduledDate])
  @@index([status])
}

// DeliveryItem: Which assemblies go in each delivery
model DeliveryItem {
  id                 String   @id @default(uuid())
  deliveryScheduleId String
  assemblyId         String

  // Relations
  deliverySchedule   DeliverySchedule @relation(fields: [deliveryScheduleId], references: [id], onDelete: Cascade)
  assembly           Assembly         @relation(fields: [assemblyId], references: [id])

  @@unique([deliveryScheduleId, assemblyId])
  @@index([deliveryScheduleId])
  @@index([assemblyId])
}

// ============================================================================
// QUALITY MANAGEMENT
// ============================================================================

// QualityCheck: Inspection per assembly or process stage
model QualityCheck {
  id            String    @id @default(uuid())
  projectId     String
  assemblyId    String?             // Optional - can be project-level or assembly-level
  processStage  ProcessStage
  type          QualityCheckType
  status        QualityCheckStatus @default(PENDING)
  inspectedBy   String?
  inspectedAt   DateTime?
  dueDate       DateTime?
  findings      String?             // Notes/findings
  ncr           String?             // NCR reference if failed
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  project       Project   @relation(fields: [projectId], references: [id])
  assembly      Assembly? @relation(fields: [assemblyId], references: [id])
  documents     ProjectDocument[]   // QC evidence photos

  @@index([projectId])
  @@index([assemblyId])
  @@index([status])
  @@index([processStage])
}

// ============================================================================
// WORK ORDERS
// ============================================================================

// WorkOrder: Groups pieces/assemblies for a work session
model WorkOrder {
  id            String    @id @default(uuid())
  projectId     String
  workOrderNumber String             // e.g., "WO-2024-001"
  title         String
  description   String?
  type          WorkOrderType
  priority      WorkOrderPriority @default(MEDIUM)
  status        WorkOrderStatus @default(PENDING)
  assignedTo    String?             // Worker/team
  scheduledDate DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  notes         String?
  blockedByWOId String?             // WO that must complete before this can start
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  project       Project         @relation(fields: [projectId], references: [id])
  items         WorkOrderItem[]
  blockedBy     WorkOrder?      @relation("WOBlocking", fields: [blockedByWOId], references: [id])
  blocking      WorkOrder[]     @relation("WOBlocking")

  @@unique([projectId, workOrderNumber])
  @@index([projectId])
  @@index([status])
  @@index([type])
  @@index([scheduledDate])
  @@index([blockedByWOId])
}

// WorkOrderItem: Links pieces or assemblies to a work order
model WorkOrderItem {
  id            String   @id @default(uuid())
  workOrderId   String
  pieceId       String?             // Link to PartPiece
  assemblyId    String?             // Or link to Assembly
  platePartId   String?             // Or link to PlatePart
  status        WorkOrderStatus   @default(PENDING)  // PENDING → IN_PROGRESS → COMPLETED
  completedAt   DateTime?
  notes         String?

  // Relations
  workOrder     WorkOrder  @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  piece         PartPiece? @relation(fields: [pieceId], references: [id])
  assembly      Assembly?  @relation(fields: [assemblyId], references: [id])
  platePart     PlatePart? @relation(fields: [platePartId], references: [id])
  usageLines    UsageLine[]

  @@index([workOrderId])
  @@index([pieceId])
  @@index([assemblyId])
  @@index([platePartId])
}

// ============================================================================
// DOCUMENTS & PHOTOS
// ============================================================================

// ProjectDocument: Files attached to project, assembly, piece, or QC
model ProjectDocument {
  id              String   @id @default(uuid())
  projectId       String
  assemblyId      String?           // Optional link
  pieceId         String?           // Optional link
  platePartId     String?           // Optional link
  qualityCheckId  String?           // Optional link for QC evidence
  type            String            // DRAWING, PHOTO, CERTIFICATE, SPEC, NCR, OTHER
  filename        String            // Original filename
  storagePath     String            // Blob path: projects/{projectId}/documents/{filename}
  mimeType        String?
  fileSize        Int?              // bytes
  description     String?
  uploadedBy      String?
  uploadedAt      DateTime @default(now())

  // Relations
  project         Project       @relation(fields: [projectId], references: [id])
  assembly        Assembly?     @relation(fields: [assemblyId], references: [id])
  piece           PartPiece?    @relation(fields: [pieceId], references: [id])
  platePart       PlatePart?    @relation(fields: [platePartId], references: [id])
  qualityCheck    QualityCheck? @relation(fields: [qualityCheckId], references: [id])

  @@index([projectId])
  @@index([assemblyId])
  @@index([pieceId])
  @@index([platePartId])
  @@index([qualityCheckId])
  @@index([type])
}

// ============================================================================
// PLATE PARTS (Outsourced Laser/Plasma Cut)
// ============================================================================

// PlatePart: Parts cut from plate (outsourced laser/plasma)
model PlatePart {
  id              String    @id @default(uuid())
  projectId       String
  partNumber      String              // e.g., "PL-001"
  description     String?
  material        String?             // e.g., "S355 10mm plate"
  gradeId         String?             // Link to MaterialGrade
  thickness       Float?              // mm
  width           Float?              // mm - plate width
  length          Float?              // mm - plate length (cutting length)
  quantity        Int                 // Total pieces needed
  unitWeight      Float     @default(0)  // kg per piece (auto-calculated from dimensions)
  isOutsourced    Boolean   @default(true)  // Default plates are outsourced
  dxfFilename     String?             // Original DXF filename
  dxfStoragePath  String?             // Blob path: projects/{projectId}/Plates/{filename}
  nestingSheet    String?             // Nesting sheet reference
  supplier        String?             // Outsource vendor name
  poNumber        String?             // Purchase order number
  status          PlatePartStatus @default(PENDING)
                  // PENDING → ORDERED → IN_PRODUCTION → RECEIVED → QC_PASSED
  orderedAt       DateTime?
  expectedDate    DateTime?
  receivedAt      DateTime?
  receivedQty     Int       @default(0)
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  project         Project        @relation(fields: [projectId], references: [id])
  grade           MaterialGrade? @relation(fields: [gradeId], references: [id])
  assemblyParts   PlateAssemblyPart[]
  documents       ProjectDocument[]
  workOrderItems  WorkOrderItem[]
  pieces          PlatePiece[]

  @@unique([projectId, partNumber])
  @@index([projectId])
  @@index([status])
  @@index([supplier])
}

// PlatePiece: Individual plate tracking (Piece 1 of 5)
model PlatePiece {
  id              String    @id @default(uuid())
  platePartId     String
  pieceNumber     Int       // 1, 2, ...
  status          PlatePieceStatus @default(PENDING)
                  // PENDING → CUT → RECEIVED → QC_PASSED
  
  inventoryId     String?   // Virtual Inventory (Batch) ID for traceability
  receivedAt      DateTime?
  receivedBy      String?   // User ID
  notes           String?

  // Relations
  platePart       PlatePart @relation(fields: [platePartId], references: [id], onDelete: Cascade)
  inventory       Inventory? @relation(fields: [inventoryId], references: [id])

  @@unique([platePartId, pieceNumber])
  @@index([platePartId])
  @@index([status])
  @@index([inventoryId])
}

// PlateAssemblyPart: Junction for plate parts in assemblies

// PlateAssemblyPart: Junction for plate parts in assemblies
model PlateAssemblyPart {
  id                  String   @id @default(uuid())
  assemblyId          String
  platePartId         String
  quantityInAssembly  Int      @default(1)
  notes               String?

  // Relations
  assembly            Assembly  @relation(fields: [assemblyId], references: [id], onDelete: Cascade)
  platePart           PlatePart @relation(fields: [platePartId], references: [id], onDelete: Cascade)

  @@unique([assemblyId, platePartId])
  @@index([assemblyId])
  @@index([platePartId])
}

// ============================================================================
// OPTIMIZATION / BACKGROUND JOBS
// ============================================================================

model OptimizationJob {
  id          String   @id @default(uuid())
  projectId   String
  type        String   // NESTING, WEIGHT_RECALC, IMPORT_DRAWINGS
  status      OptimizationJobStatus @default(PENDING) // PENDING, PROCESSING, COMPLETED, FAILED
  parameters  Json?    // Input params
  result      Json?    // Output result or summary
  error       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?

  project     Project  @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([status])
}

model ParsedDrawing {
  id          String   @id @default(uuid())
  jobId       String   // Batch ID for grouping
  projectId   String
  filename    String
  fileUrl     String   // Storage path
  status      String   // PENDING, PROCESSING, COMPLETED, FAILED
  result      Json?    // confirm to ParsedPart interface
  rawResponse Json?    // Raw JSON from Gemini for auditing
  error       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([jobId])
  @@index([status])
  @@index([projectId])
}
